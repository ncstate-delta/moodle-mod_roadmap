{"version":3,"sources":["../src/step_activity_select.js"],"names":["define","$","notification","templates","ajax","Dialogue","stepsave","StepActivitySelector","prototype","rebind_checkbox","console","log","unbind","each","index","chk","stepid","data","prop","click","input","configure_checkbox","multipleActivities","val","split","length","rebind_buttons","showConfig","bind","event","self","activityData","JSON","parse","clickedButton","target","render","done","html","initActivityConfig","fail","exception","loadList","listAreas","i","e","stepCompletionModules","closest","find","selectedIds","children","remove","activities","forEach","activity","inArray","coursemoduleid","li","attr","appendTo","text","name","append","trigger","popup","body","getContent","on","values","toArray","map","item","value","join","stepId","rebind_inputs","close","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle opening a dialogue to configure scale data.\n *\n * @module     mod_roadmap/stepactivityselect\n * @package    mod_roadmap\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/notification', 'core/templates', 'core/ajax', 'mod_roadmap/dialogue',\n        'mod_roadmap/step_save'],\n    function($, notification, templates, ajax, Dialogue, stepsave) {\n\n        var StepActivitySelector = function() {\n\n        };\n\n        StepActivitySelector.prototype.rebind_checkbox = function() {\n            console.log('StepActivitySelector.prototype.rebind_checkbox');\n            $('.chk-single-activity-link').unbind('click').each(function(index, chk) {\n                let stepid = $(chk).data('stepid');\n                $('#step-' + stepid + '-single-activity-link').prop(\"disabled\", $(chk).prop('checked'));\n\n                $(chk).click(function() {\n                    let stepid = $(this).data('stepid');\n                    $('#step-' + stepid + '-single-activity-link').prop(\"disabled\", $(this).prop('checked'));\n                });\n            });\n\n            $('.completion-modules').unbind('change').each(function(index, input) {\n                StepActivitySelector.prototype.configure_checkbox(input);\n            });\n        };\n\n        StepActivitySelector.prototype.configure_checkbox = function(input) {\n            console.log('StepActivitySelector.prototype.configure_checkbox');\n            let stepid = $(input).data('stepid');\n            let multipleActivities = ($('#step-' + stepid + '-completion-modules').val().split(',').length > 1);\n\n            $('#step-' + stepid + '-chk-single-activity-link').prop(\"disabled\", multipleActivities);\n            if (multipleActivities) {\n                $('#step-' + stepid + '-chk-single-activity-link').prop(\"checked\", !multipleActivities);\n                $('#step-' + stepid + '-single-activity-link').prop(\"disabled\", !multipleActivities);\n            }\n        };\n\n        StepActivitySelector.prototype.rebind_buttons = function() {\n            console.log('StepActivitySelector.prototype.rebind_buttons');\n            $('.btn_completion_selector').unbind('click').click(this.showConfig.bind(this));\n        };\n\n        StepActivitySelector.prototype.showConfig = function(event) {\n            console.log('StepActivitySelector.prototype.showConfig');\n            var self = this;\n            var activityData = JSON.parse($('input[name=\"activity_data\"]').val());\n            self.clickedButton = event.target;\n\n            // Dish up the form.\n            templates.render('mod_roadmap/configuration_activityselect', activityData)\n                .done(function(html) {\n                    new Dialogue(\n                        'Select Activities for Step Completion',\n                        html,\n                        self.initActivityConfig.bind(self)\n                    );\n                }).fail(notification.exception);\n        };\n\n        StepActivitySelector.prototype.loadList = function() {\n            console.log('StepActivitySelector.prototype.loadList');\n            var activityData = JSON.parse($('input[name=\"activity_data\"]').val());\n            var listAreas = $('ul.step-completion-list');\n\n            $(listAreas).each(function(i, e) {\n\n                // get the configuration line from the local hidden field\n                //let stepConfig = JSON.parse($(this).closest('.step-container').children('.step-configuration').val());\n                var stepCompletionModules = $(this).closest('.step-activity-container').find('.step-completion-modules').val();\n                var selectedIds = stepCompletionModules.split(',');\n\n                $(e).children('li').remove();\n                console.log(activityData.activities);\n                console.log(activityData.activities[0]);\n                // Use the selected ids to get course module information\n                activityData.activities.forEach(function (activity) {\n                    if ($.inArray(activity.coursemoduleid, selectedIds)>=0) {\n                        var li = $('<li/>').attr('data-id', activity.coursemoduleid).appendTo($(e));\n                        $('<span>').text(activity.name).appendTo(li);\n                        $(e).append(li);\n                    }\n                });\n\n                $(e).trigger('change');\n                StepActivitySelector.prototype.configure_checkbox(\n                    $(this).closest('.step-activity-container').find('.step-completion-modules'));\n            });\n\n        };\n\n        StepActivitySelector.prototype.initActivityConfig = function(popup) {\n            console.log('StepActivitySelector.prototype.initActivityConfig');\n            this.popup = popup;\n            var body = $(popup.getContent());\n\n            body.on('click', '[data-action=\"save\"]', function() {\n                let values = $('#step-activity-selector option:selected').toArray()\n                        .map(item => item.value).join(',');\n\n                let stepId = $(this.clickedButton).data('stepid');\n                $('#step-' + stepId + '-completion-modules').val(values).trigger('change');\n\n                StepActivitySelector.prototype.loadList();\n                stepsave.rebind_inputs();\n                popup.close();\n            }.bind(this));\n            body.on('click', '[data-action=\"cancel\"]', function() {\n                popup.close();\n            });\n        };\n\n        return {\n\n            /**\n             * Main initialisation.\n             *\n             * @param {String} selectSelector The select box selector.\n             * @param {String} inputSelector The hidden input field selector.\n             * @param {String} triggerSelector The trigger selector.\n             * @return {ScaleConfig} A new instance of ScaleConfig.\n             * @method init\n             */\n            init: function() {\n                return new StepActivitySelector();\n            },\n\n            rebind_buttons: function() {\n                StepActivitySelector.prototype.rebind_buttons();\n                StepActivitySelector.prototype.rebind_checkbox();\n                StepActivitySelector.prototype.loadList();\n            }\n        };\n    });"],"file":"step_activity_select.min.js"}