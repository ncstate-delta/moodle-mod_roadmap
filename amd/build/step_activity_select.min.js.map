{"version":3,"file":"step_activity_select.min.js","sources":["../src/step_activity_select.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle opening a modal for activity selection.\n *\n * @module     mod_roadmap/stepactivityselect\n * @copyright  2021 Steve Bader <smbader@ncsu.edu>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'core/templates',\n    'mod_roadmap/repository',\n    'core/modal_save_cancel',\n    'core/modal_events',\n    'mod_roadmap/step_save'\n], function(\n    $,\n    Str,\n    Notification,\n    Templates,\n    RoadmapRepository,\n    ModalSaveCancel,\n    ModalEvents,\n    StepSave\n) {\n\n    var SELECTORS = {\n        SELECT_ACTIVITY_BUTTON: '.btn_completion_selector'\n    };\n\n    var StepActivitySelector = function() {\n        this.registerEventListeners();\n    };\n\n    StepActivitySelector.prototype.registerEventListeners = function() {\n\n        var trigger = $(SELECTORS.SELECT_ACTIVITY_BUTTON);\n        var stringkeys = [\n            {\n                key: 'chooseactivities',\n                component: 'mod_roadmap'\n            },\n            {\n                key: 'saveselection',\n                component: 'mod_roadmap'\n            }\n        ];\n\n        trigger.off('click').on('click', function(e) {\n            let stepId = $(e.target).parent('.btn_completion_selector').data('stepid');\n\n            Str.get_strings(stringkeys).then(function(strings) {\n                return Promise.all([\n                    ModalSaveCancel.create({\n                        title: strings[0],\n                        body: '',\n                    }),\n                    strings[1],\n                ]).then(function([modal, string]) {\n                    this.setupFormModal(modal, stepId, string);\n                    return modal;\n                }.bind(this));\n            }.bind(this))\n            .catch(Notification.exception);\n        }.bind(this));\n    };\n\n    /**\n     * @method getBody\n     * @private\n     * @return {Promise}\n     */\n    StepActivitySelector.prototype.getBody = async() => {\n        const response = await RoadmapRepository.fetchCourseModules();\n\n        // Get the content of the modal.\n        return Templates.render('mod_roadmap/configuration_activityselect', response);\n    };\n\n\n    StepActivitySelector.prototype.setupFormModal = function(modal, stepId, saveText) {\n        modal.setLarge();\n\n        modal.setSaveButtonText(saveText);\n\n        // We want to reset the form every time it is opened.\n        modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n        modal.setBody(this.getBody());\n\n        modal.getRoot().on('click', '#activity-select-window .activity input[type=\"checkbox\"]', function() {\n            this.updateExpectedCompleteDropdown();\n        }.bind(this));\n\n        modal.getRoot().on(ModalEvents.bodyRendered, function() {\n            $('#step-id').val(stepId);\n\n            // Check off all course modules currently selected.\n            let stepCompletionModules = $('#step-' + stepId + '-completion-modules').val().split(',');\n            let stepExpectedCompletionCourseModule = $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val();\n            let stepExpectedCompleteDatetime = $('#step-' + stepId + '-expectedcomplete-datetime').val();\n\n            $.each(stepCompletionModules, function(i, val) {\n                $('#activity-select-window .activity input[type=\"checkbox\"][data-coursemoduleid=\"' + val + '\"]')\n                    .prop('checked', true);\n            });\n\n            this.updateExpectedCompleteDropdown();\n\n            // Select the existing option from dropdown\n            // If expected complete is a course module id, attempt to locate it in the dropdown.\n            if (stepExpectedCompletionCourseModule > 0 &&\n                $('#select-expected-activity-completion option[value=\"' + stepExpectedCompletionCourseModule + '\"]').length > 0) {\n                $('#select-expected-activity-completion option[value=\"' + stepExpectedCompletionCourseModule + '\"]')\n                    .attr(\"selected\", \"selected\");\n\n                // If the course module doesnt exist or isn't a cmid, use the datetime and select custom.\n            } else if (stepExpectedCompleteDatetime > 0) {\n                var date = new Date(stepExpectedCompleteDatetime * 1000);\n                $('#select-expected-activity-completion option[value=\"-1\"]').attr(\"selected\", \"selected\");\n                $('#customExpectedDateContainer select[name=\"today\"] option[value=\"' + date.getDate() + '\"]')\n                    .attr(\"selected\", \"selected\");\n                $('#customExpectedDateContainer select[name=\"tomonth\"] option[value=\"' + (date.getMonth() + 1) + '\"]')\n                    .attr(\"selected\", \"selected\");\n                $('#customExpectedDateContainer select[name=\"toyear\"] option[value=\"' + date.getFullYear() + '\"]')\n                    .attr(\"selected\", \"selected\");\n                $('#customExpectedDateContainer select[name=\"tohour\"] option[value=\"' + date.getHours() + '\"]')\n                    .attr(\"selected\", \"selected\");\n                $('#customExpectedDateContainer select[name=\"tominute\"] option[value=\"' + date.getMinutes() + '\"]')\n                    .attr(\"selected\", \"selected\");\n\n                // If the datetime is not a unixtime, then no completion is expected.\n            } else {\n                $('#select-expected-activity-completion option[value=\"0\"]').attr(\"selected\", \"selected\");\n            }\n\n            this.expectedCompleteDropdownChanged();\n        }.bind(this));\n\n        // We catch the modal save event, and use it to submit the form inside the modal.\n        // Triggering a form submission will give JS validation scripts a chance to check for errors.\n        modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n\n        modal.getRoot().on('submit', 'form', this.submitForm.bind(this));\n\n        this.modal = modal;\n\n        modal.show();\n    };\n\n    StepActivitySelector.prototype.expectedCompleteDropdownChanged = function() {\n        let selectedOption = $('#select-expected-activity-completion').find(':selected');\n        if (selectedOption.val() == '-1') {\n            $('#customExpectedDateContainer').show();\n        } else {\n            $('#customExpectedDateContainer').hide();\n        }\n    };\n\n    StepActivitySelector.prototype.updateExpectedCompleteDropdown = function() {\n        let select = $('#select-expected-activity-completion');\n\n        $('#activity-select-window .activity input[type=\"checkbox\"]').each(function() {\n            let coursemoduleid = $(this).data('coursemoduleid');\n            let completionexpecteddatetime = $(this).data('completionexpecteddatetime');\n            let completionexpectedreadable = $(this).data('completionexpectedreadable');\n\n            if (completionexpecteddatetime != 0) {\n                // Is the checkbox checked?\n                if ($(this).is(':checked')) {\n                    let found = false;\n                    $('#select-expected-activity-completion option').each(function() {\n                        if ($(this).val() == coursemoduleid) {\n                            found = true;\n                        }\n                    });\n                    if (found === false) {\n                        select.append($('<option>', {\n                            value: coursemoduleid,\n                            text: completionexpectedreadable + ' ' + $(this).data('name'),\n                            'data-completionexpecteddatetime': completionexpecteddatetime,\n                        }));\n                    }\n                } else {\n                    $('#select-expected-activity-completion option').each(function() {\n                        if ($(this).val() == coursemoduleid) {\n                            $(this).remove();\n                        }\n                    });\n                }\n            }\n        });\n\n        select.unbind('change').change(this.expectedCompleteDropdownChanged.bind(this));\n    };\n\n    StepActivitySelector.prototype.submitForm = function(e) {\n        // We don't want to do a real form submission.\n        e.preventDefault();\n        let stepId = $('#step-id').val();\n\n        $('#step-' + stepId + '-completion-list li').remove();\n        $('#activity-select-window .activity input[type=\"checkbox\"]:checked').each(function() {\n            $('#step-' + stepId + '-completion-list').append('<li>' + $(this).data('name') + '</li>');\n        });\n\n        // Collect the expected completion cmid and datetime\n        let selectedOption = $('#select-expected-activity-completion').find(':selected');\n        if (selectedOption.val() == 0) {\n            $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val(0);\n            $('#step-' + stepId + '-expectedcomplete-datetime').val(0);\n            $('#step-' + stepId + '-expectedcomplete-readable').html(selectedOption.text());\n\n        } else if (selectedOption.val() == -1) {\n            $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val(-1);\n            let day = $('#customExpectedDateContainer select[name=\"today\"]').find(':selected').val();\n            let month = $('#customExpectedDateContainer select[name=\"tomonth\"]').find(':selected').val();\n            let year = $('#customExpectedDateContainer select[name=\"toyear\"]').find(':selected').val();\n            let hours = $('#customExpectedDateContainer select[name=\"tohour\"]').find(':selected').val();\n            let minutes = $('#customExpectedDateContainer select[name=\"tominute\"]').find(':selected').val();\n\n            let jsDate = new Date(year, (month - 1), day, hours, minutes);\n            let unixTimestamp = Math.floor(jsDate.getTime() / 1000);\n            $('#step-' + stepId + '-expectedcomplete-datetime').val(unixTimestamp);\n\n            $('#step-' + stepId + '-expectedcomplete-readable').html(month + '/' + day + '/' + year + ' ' + hours + ':' + minutes);\n\n        } else {\n            $('#step-' + stepId + '-expectedcomplete-datetime').val(selectedOption.data('completionexpecteddatetime'));\n            $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val(selectedOption.val());\n            $('#step-' + stepId + '-expectedcomplete-readable').html(selectedOption.text());\n        }\n\n        // Collect all checked course module ids and prep them\n        // to go back to the config form.\n        let values = $('#activity-select-window .activity input[type=\"checkbox\"]:checked')\n            .map(function() {\n                return $(this).data('coursemoduleid');\n            }).get().join(',');\n\n        $('#step-' + stepId + '-completion-modules').val(values).trigger('change');\n\n        StepSave.rebindInputs();\n        this.destroy();\n    };\n\n    StepActivitySelector.prototype.destroy = function() {\n        this.modal.destroy();\n    };\n\n    return {\n\n        /**\n         * Main initialisation.\n         *\n         * @return {StepActivitySelector} A new instance of StepActivitySelector.\n         * @method init\n         */\n        init: function() {\n            return new StepActivitySelector();\n        },\n\n        rebindButtons: function() {\n            StepActivitySelector.prototype.registerEventListeners();\n        }\n    };\n});"],"names":["define","$","Str","Notification","Templates","RoadmapRepository","ModalSaveCancel","ModalEvents","StepSave","SELECTORS","StepActivitySelector","registerEventListeners","prototype","trigger","stringkeys","key","component","off","on","e","stepId","target","parent","data","get_strings","then","strings","Promise","all","create","title","body","modal","string","setupFormModal","bind","this","catch","exception","getBody","async","response","fetchCourseModules","render","saveText","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","updateExpectedCompleteDropdown","bodyRendered","val","stepCompletionModules","split","stepExpectedCompletionCourseModule","stepExpectedCompleteDatetime","each","i","prop","length","attr","date","Date","getDate","getMonth","getFullYear","getHours","getMinutes","expectedCompleteDropdownChanged","save","submitForm","show","find","hide","select","coursemoduleid","completionexpecteddatetime","completionexpectedreadable","is","found","append","value","text","remove","unbind","change","preventDefault","selectedOption","html","day","month","year","hours","minutes","jsDate","unixTimestamp","Math","floor","getTime","values","map","get","join","rebindInputs","init","rebindButtons"],"mappings":"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"}