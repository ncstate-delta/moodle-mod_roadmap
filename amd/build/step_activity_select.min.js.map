{"version":3,"file":"step_activity_select.min.js","sources":["../src/step_activity_select.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle opening a dialogue to configure scale data.\n *\n * @module     mod_roadmap/stepactivityselect\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/notification',\n    'core/templates',\n    'mod_roadmap/repository',\n    'core/modal_factory',\n    'core/modal_events',\n    'mod_roadmap/step_save'\n], function(\n    $,\n    notification,\n    templates,\n    roadmapRepository,\n    ModalFactory,\n    ModalEvents,\n    stepsave\n) {\n\n\n    var SELECTORS = {\n        SELECT_ACTIVITY_BUTTON: '.btn_completion_selector'\n    };\n\n    var StepActivitySelector = function() {\n        this.registerEventListeners();\n    };\n\n    StepActivitySelector.prototype.registerEventListeners = function() {\n\n        var trigger = $(SELECTORS.SELECT_ACTIVITY_BUTTON);\n\n        trigger.off('click').on('click', function(e) {\n            let stepId = $(e.target).data('stepid');\n\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: 'Choose Activities for Step Completion',\n                body: '',\n            }, trigger).done(function(modal) {\n                this.setupFormModal(modal, stepId, 'Save Selection');\n            }.bind(this));\n        }.bind(this));\n    };\n\n    /**\n     * @method getBody\n     * @private\n     * @return {Promise}\n     */\n    StepActivitySelector.prototype.getBody = async() => {\n        const response = await roadmapRepository.fetchCourseModules();\n\n\n        // Get the content of the modal.\n        return templates.render('mod_roadmap/configuration_activityselect', response);\n    };\n\n\n    StepActivitySelector.prototype.setupFormModal = function(modal, stepId, saveText) {\n        modal.setLarge();\n\n        modal.setSaveButtonText(saveText);\n\n        // We want to reset the form every time it is opened.\n        modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n        modal.setBody(this.getBody());\n\n        modal.getRoot().on('click', '#activity-select-window .activity input[type=\"checkbox\"]', function() {\n            this.updateExpectedCompleteDropdown();\n        }.bind(this));\n\n        modal.getRoot().on(ModalEvents.bodyRendered, function() {\n            $('#step-id').val(stepId);\n\n            // Check off all course modules currently selected.\n            let stepCompletionModules = $('#step-' + stepId + '-completion-modules').val().split(',');\n            let stepExpectedCompletionCourseModule = $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val();\n            let stepExpectedCompleteDatetime = $('#step-' + stepId + '-expectedcomplete-datetime').val();\n\n            $.each(stepCompletionModules, function(i , val) {\n                $('#activity-select-window .activity input[type=\"checkbox\"][data-coursemoduleid=\"' + val + '\"]')\n                    .prop('checked', true);\n            });\n\n            this.updateExpectedCompleteDropdown();\n\n            // Select the existing option from dropdown\n            // If expected complete is a course module id, attempt to locate it in the dropdown.\n            if (stepExpectedCompletionCourseModule > 0 &&\n                $('#select-expected-activity-completion option[value=\"' + stepExpectedCompletionCourseModule + '\"]').length > 0) {\n                $('#select-expected-activity-completion option[value=\"' + stepExpectedCompletionCourseModule + '\"]')\n                    .attr(\"selected\",\"selected\");\n\n                // If the course module doesnt exist or isn't a cmid, use the datetime and select custom.\n            } else if (stepExpectedCompleteDatetime > 0) {\n                var date = new Date(stepExpectedCompleteDatetime * 1000);\n                $('#select-expected-activity-completion option[value=\"-1\"]').attr(\"selected\", \"selected\");\n                $('#customExpectedDateContainer select[name=\"today\"] option[value=\"' + date.getDate() + '\"]')\n                    .attr(\"selected\",\"selected\");\n                $('#customExpectedDateContainer select[name=\"tomonth\"] option[value=\"' + (date.getMonth()+1) + '\"]')\n                    .attr(\"selected\",\"selected\");\n                $('#customExpectedDateContainer select[name=\"toyear\"] option[value=\"' + date.getFullYear() + '\"]')\n                    .attr(\"selected\",\"selected\");\n                $('#customExpectedDateContainer select[name=\"tohour\"] option[value=\"' + date.getHours() + '\"]')\n                    .attr(\"selected\",\"selected\");\n                $('#customExpectedDateContainer select[name=\"tominute\"] option[value=\"' + date.getMinutes() + '\"]')\n                    .attr(\"selected\",\"selected\");\n\n                // If the datetime is not a unixtime, then no completion is expected.\n            } else {\n                $('#select-expected-activity-completion option[value=\"0\"]').attr(\"selected\", \"selected\");\n            }\n\n            this.expectedCompleteDropdownChanged();\n        }.bind(this));\n\n        // We catch the modal save event, and use it to submit the form inside the modal.\n        // Triggering a form submission will give JS validation scripts a chance to check for errors.\n        modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n\n        modal.getRoot().on('submit', 'form', this.submitForm.bind(this));\n\n        this.modal = modal;\n\n        modal.show();\n    };\n\n    StepActivitySelector.prototype.expectedCompleteDropdownChanged = function () {\n        let selectedOption = $('#select-expected-activity-completion').find(':selected');\n        if (selectedOption.val() == '-1') {\n            $('#customExpectedDateContainer').show();\n        } else {\n            $('#customExpectedDateContainer').hide();\n        }\n    };\n\n    StepActivitySelector.prototype.updateExpectedCompleteDropdown = function () {\n        let select = $('#select-expected-activity-completion');\n\n        $('#activity-select-window .activity input[type=\"checkbox\"]').each(function() {\n            let coursemoduleid = $(this).data('coursemoduleid');\n            let completionexpecteddatetime = $(this).data('completionexpecteddatetime');\n            let completionexpectedreadable = $(this).data('completionexpectedreadable');\n\n            if (completionexpecteddatetime != 0) {\n                // Is the checkbox checked?\n                if ($(this).is(':checked')) {\n                    let found = false;\n                    $('#select-expected-activity-completion option').each(function() {\n                        if ($(this).val() == coursemoduleid) {\n                            found = true;\n                        }\n                    });\n                    if (found === false) {\n                        select.append($('<option>', {\n                            value: coursemoduleid,\n                            text: completionexpectedreadable + ' ' + $(this).data('name'),\n                            'data-completionexpecteddatetime': completionexpecteddatetime,\n                        }));\n                    }\n                } else {\n                    $('#select-expected-activity-completion option').each(function() {\n                        if ($(this).val() == coursemoduleid) {\n                            $(this).remove();\n                        }\n                    });\n                }\n            }\n        });\n\n        select.unbind('change').change(this.expectedCompleteDropdownChanged.bind(this));\n    };\n\n    StepActivitySelector.prototype.submitForm = function(e) {\n        // We don't want to do a real form submission.\n        e.preventDefault();\n        let stepId = $('#step-id').val();\n\n        $('#step-' + stepId + '-completion-list li').remove();\n        $('#activity-select-window .activity input[type=\"checkbox\"]:checked').each(function() {\n            $('#step-' + stepId + '-completion-list').append('<li>' + $(this).data('name') + '</li>');\n        });\n\n        // Collect the expected completion cmid and datetime\n        let selectedOption = $('#select-expected-activity-completion').find(':selected');\n        if (selectedOption.val() == 0) {\n            $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val(0);\n            $('#step-' + stepId + '-expectedcomplete-datetime').val(0);\n            $('#step-' + stepId + '-expectedcomplete-readable').html(selectedOption.text());\n\n        } else if (selectedOption.val() == -1) {\n            $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val(-1);\n            let day = $('#customExpectedDateContainer select[name=\"today\"]').find(':selected').val();\n            let month = $('#customExpectedDateContainer select[name=\"tomonth\"]').find(':selected').val();\n            let year = $('#customExpectedDateContainer select[name=\"toyear\"]').find(':selected').val();\n            let hours = $('#customExpectedDateContainer select[name=\"tohour\"]').find(':selected').val();\n            let minutes = $('#customExpectedDateContainer select[name=\"tominute\"]').find(':selected').val();\n\n            let jsDate = new Date(year,(month-1),day,hours,minutes);\n            let unixTimestamp = Math.floor(jsDate.getTime() / 1000);\n            $('#step-' + stepId + '-expectedcomplete-datetime').val(unixTimestamp);\n\n            $('#step-' + stepId + '-expectedcomplete-readable').html(month + '/' + day + '/' + year + ' ' + hours + ':' + minutes);\n\n        } else {\n            $('#step-' + stepId + '-expectedcomplete-datetime').val(selectedOption.data('completionexpecteddatetime'));\n            $('#step-' + stepId + '-expectedcomplete-coursemoduleid').val(selectedOption.val());\n            $('#step-' + stepId + '-expectedcomplete-readable').html(selectedOption.text());\n        }\n\n        // Collect all checked course module ids and prep them\n        // to go back to the config form.\n        let values = $('#activity-select-window .activity input[type=\"checkbox\"]:checked')\n            .map(function() { return $(this).data('coursemoduleid'); }).get().join(',');\n\n        $('#step-' + stepId + '-completion-modules').val(values).trigger('change');\n\n        stepsave.rebindInputs();\n        this.destroy();\n    };\n\n    StepActivitySelector.prototype.destroy = function() {\n        this.modal.destroy();\n    };\n\n    return {\n\n        /**\n         * Main initialisation.\n         *\n         * @return {StepActivitySelector} A new instance of StepActivitySelector.\n         * @method init\n         */\n        init: function() {\n            return new StepActivitySelector();\n        },\n\n        rebindButtons: function() {\n            StepActivitySelector.prototype.registerEventListeners();\n        }\n    };\n});"],"names":["define","$","notification","templates","roadmapRepository","ModalFactory","ModalEvents","stepsave","SELECTORS","StepActivitySelector","registerEventListeners","prototype","trigger","off","on","e","stepId","target","data","create","type","types","SAVE_CANCEL","title","body","done","modal","setupFormModal","bind","this","getBody","async","response","fetchCourseModules","render","saveText","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","updateExpectedCompleteDropdown","bodyRendered","val","stepCompletionModules","split","stepExpectedCompletionCourseModule","stepExpectedCompleteDatetime","each","i","prop","length","attr","date","Date","getDate","getMonth","getFullYear","getHours","getMinutes","expectedCompleteDropdownChanged","save","submitForm","show","find","hide","select","coursemoduleid","completionexpecteddatetime","completionexpectedreadable","is","found","append","value","text","remove","unbind","change","preventDefault","selectedOption","html","day","month","year","hours","minutes","jsDate","unixTimestamp","Math","floor","getTime","values","map","get","join","rebindInputs","init","rebindButtons"],"mappings":"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"}