/**
 * Handle the configuration of the roadmap.
 *
 * @module     mod_roadmap/roadmapconfig
 * @copyright  2021 Steve Bader <smbader@ncsu.edu>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_roadmap/roadmap_config",["jquery","core/notification","core/templates","mod_roadmap/expand_contract","mod_roadmap/learningobjectivesconfig","mod_roadmap/step_icon_select","mod_roadmap/step_activity_select","mod_roadmap/step_save","mod_roadmap/cycle_save","mod_roadmap/phase_save"],(function($,notification,templates,ec,learningobjectives,stepiconselect,stepactivityselect,stepsave,cyclesave,phasesave){var RoadmapConfig=function(inputSelector,inputConfig){this.inputSelector=inputSelector,this.configContainer=$(inputConfig),this.initForm()};return RoadmapConfig.prototype.initForm=function(){var self=this,inputConfigVal=this.configContainer.val();""==inputConfigVal&&(inputConfigVal=JSON.stringify({phases:[]}),this.configContainer.val(inputConfigVal));var config=JSON.parse(inputConfigVal);$.each(config.phases,(function(p){let phase=config.phases[p];phase.configuration=JSON.stringify(phase),$.each(phase.cycles,(function(c){let cycle=phase.cycles[c];cycle.configuration=JSON.stringify(cycle),$.each(cycle.steps,(function(s){let step=cycle.steps[s];step.configuration=JSON.stringify(step)}))}))})),templates.render("mod_roadmap/configuration_phases",config).then((function(html,js){return templates.prependNodeContents(self.inputSelector,html,js),$("#add-phase").click((function(e){RoadmapConfig.prototype.addPhase(e)})),$(".add-phase-cycle").click((function(e){RoadmapConfig.prototype.addCycle(e)})),$(".add-cycle-step").click((function(e){RoadmapConfig.prototype.addStep(e)})),$(".phase-collapse-control").click((function(e){RoadmapConfig.prototype.collapsePhase(e)})),$(".cycle-collapse-control").click((function(e){RoadmapConfig.prototype.collapseCycle(e)})),$(".step-collapse-control").click((function(e){RoadmapConfig.prototype.collapseStep(e)})),$(".phase-delete-control").click((function(e){RoadmapConfig.prototype.deletePhase(e)})),$(".cycle-delete-control").click((function(e){RoadmapConfig.prototype.deleteCycle(e)})),$(".step-delete-control").click((function(e){RoadmapConfig.prototype.deleteStep(e)})),$(".phase-up-control").click((function(e){RoadmapConfig.prototype.upPhase(e)})),$(".phase-down-control").click((function(e){RoadmapConfig.prototype.downPhase(e)})),$(".cycle-up-control").click((function(e){RoadmapConfig.prototype.upCycle(e)})),$(".cycle-down-control").click((function(e){RoadmapConfig.prototype.downCycle(e)})),$(".step-up-control").click((function(e){RoadmapConfig.prototype.upStep(e)})),$(".step-down-control").click((function(e){RoadmapConfig.prototype.downStep(e)})),learningobjectives.refreshChecklists(),stepiconselect.rebindButtons(),stepactivityselect.rebindButtons(),stepsave.rebindInputs(),cyclesave.rebindInputs(),phasesave.rebindInputs(),RoadmapConfig.prototype.bindConfigSave(),require(["theme_boost/loader"]),null})).fail(notification.exception)},RoadmapConfig.prototype.bindConfigSave=function(){$("input.phase-configuration").unbind("change").change(this.configSave.bind(this))},RoadmapConfig.prototype.configSave=function(){var phaseContainer=$("#phase-container"),roadmapData=[];let index=0;$.each(phaseContainer.find(".phase-wrapper .phase-configuration"),(function(){let phaseData=$(this).val();""==phaseData&&(phaseData="{}");let phaseDataObj=JSON.parse(phaseData);phaseDataObj.index=index,index+=1,roadmapData.push(phaseDataObj)})),$('input[name="roadmapconfiguration"]').val(JSON.stringify({phases:roadmapData,phaseDeletes:$("#phase-deletes").val(),cycleDeletes:$("#cycle-deletes").val(),stepDeletes:$("#step-deletes").val()}))},RoadmapConfig.prototype.addPhase=function(event){event.preventDefault(),event.stopPropagation();var config=JSON.parse($('input[name="roadmapconfiguration"]').val()),nextIndex=config.phases.length,newPhase={id:parseInt(RoadmapConfig.prototype.maxValue("phase"))+1,index:nextIndex,number:nextIndex+1};config.phases.push(newPhase),$('input[name="roadmapconfiguration"]').val(JSON.stringify(config)),templates.render("mod_roadmap/configuration_phase",newPhase).then((function(html,js){return templates.appendNodeContents("#phase-container",html,js),$(".phase-collapse-control").unbind("click").click((function(e){RoadmapConfig.prototype.collapsePhase(e)})),$(".phase-delete-control").unbind("click").click((function(e){RoadmapConfig.prototype.deletePhase(e)})),$(".phase-up-control").unbind("click").click((function(e){RoadmapConfig.prototype.upPhase(e)})),$(".phase-down-control").unbind("click").click((function(e){RoadmapConfig.prototype.downPhase(e)})),$("#add-phase").unbind("click").click((function(e){RoadmapConfig.prototype.addPhase(e)})),$(".add-phase-cycle").unbind("click").click((function(e){RoadmapConfig.prototype.addCycle(e)})),phasesave.rebindInputs(),RoadmapConfig.prototype.bindConfigSave(),null})).fail(notification.exception)},RoadmapConfig.prototype.addCycle=function(event){event.preventDefault(),event.stopPropagation();var cycleContainer=$(event.currentTarget).closest(".phase-container").children(".phase-cycles-container"),nextCycleIndex=cycleContainer.children(".cycle-wrapper").length;var newCycle={id:parseInt(RoadmapConfig.prototype.maxValue("cycle"))+1,index:nextCycleIndex,number:nextCycleIndex+1};templates.render("mod_roadmap/configuration_cycle",newCycle).then((function(html,js){return templates.appendNodeContents(cycleContainer,html,js),$(".cycle-collapse-control").unbind("click").click((function(e){RoadmapConfig.prototype.collapseCycle(e)})),$(".cycle-delete-control").unbind("click").click((function(e){RoadmapConfig.prototype.deleteCycle(e)})),$(".cycle-up-control").unbind("click").click((function(e){RoadmapConfig.prototype.upCycle(e)})),$(".cycle-down-control").unbind("click").click((function(e){RoadmapConfig.prototype.downCycle(e)})),$(".add-cycle-step").unbind("click").click((function(e){RoadmapConfig.prototype.addStep(e)})),learningobjectives.refreshChecklists(),cyclesave.rebindInputs(),phasesave.rebindInputs(),null})).fail(notification.exception)},RoadmapConfig.prototype.addStep=function(event){event.preventDefault(),event.stopPropagation();var stepsContainer=$(event.currentTarget).closest(".cycle-container").children(".cycle-steps-container"),nextStepIndex=stepsContainer.children(".step-wrapper").length;var newStep={id:parseInt(RoadmapConfig.prototype.maxValue("step"))+1,index:nextStepIndex,number:nextStepIndex+1,stepicon:"icon-10",iconurl:$('input[name="icon_url"]').val()+"?name=icon-10&percent=100&flags=n"};templates.render("mod_roadmap/configuration_step",newStep).then((function(html,js){return templates.appendNodeContents(stepsContainer,html,js),$(".step-collapse-control").unbind("click").click((function(e){RoadmapConfig.prototype.collapseStep(e)})),$(".step-delete-control").unbind("click").click((function(e){RoadmapConfig.prototype.deleteStep(e)})),$(".step-up-control").unbind("click").click((function(e){RoadmapConfig.prototype.upStep(e)})),$(".step-down-control").unbind("click").click((function(e){RoadmapConfig.prototype.downStep(e)})),stepiconselect.rebindButtons(),stepactivityselect.rebindButtons(),stepsave.rebindInputs(),cyclesave.rebindInputs(),null})).fail(notification.exception)},RoadmapConfig.prototype.collapsePhase=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),metadata=thisnode.closest(".phase-wrapper").children(".phase-container");ec.expandCollapse(metadata,thisnode)},RoadmapConfig.prototype.collapseCycle=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),metadata=thisnode.closest(".cycle-wrapper").children(".cycle-container");ec.expandCollapse(metadata,thisnode)},RoadmapConfig.prototype.collapseStep=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),metadata=thisnode.closest(".step-wrapper").children(".step-container");ec.expandCollapse(metadata,thisnode)},RoadmapConfig.prototype.deletePhase=function(event){if(event.preventDefault(),event.stopPropagation(),window.confirm("Are you sure you want to delete this Phase?")){var phaseWrapper=$(event.currentTarget).closest(".phase-wrapper"),phaseId=phaseWrapper.data("phaseid");$("#phase-deletes").val($("#phase-deletes").val()+phaseId+","),phaseWrapper.remove(),RoadmapConfig.prototype.configSave()}},RoadmapConfig.prototype.deleteCycle=function(event){if(event.preventDefault(),event.stopPropagation(),window.confirm("Are you sure you want to delete this Cycle?")){var thisnode=$(event.currentTarget),cycleWrapper=thisnode.closest(".cycle-wrapper"),phaseContainer=thisnode.closest(".phase-container"),cycleId=cycleWrapper.data("cycleid");$("#cycle-deletes").val($("#cycle-deletes").val()+cycleId+","),cycleWrapper.remove(),phaseContainer.find(".phase-title").triggerHandler("change")}},RoadmapConfig.prototype.deleteStep=function(event){if(event.preventDefault(),event.stopPropagation(),window.confirm("Are you sure you want to delete this Step?")){var thisnode=$(event.currentTarget),stepWrapper=thisnode.closest(".step-wrapper"),cycleContainer=thisnode.closest(".cycle-container"),stepId=stepWrapper.data("stepid");$("#step-deletes").val($("#step-deletes").val()+stepId+","),stepWrapper.remove(),cycleContainer.find(".cycle-title").triggerHandler("change")}},RoadmapConfig.prototype.upPhase=function(event){event.preventDefault(),event.stopPropagation();var phaseWrapper=$(event.currentTarget).closest(".phase-wrapper"),prevPhaseWrapper=phaseWrapper.prev();phaseWrapper.insertBefore(prevPhaseWrapper),RoadmapConfig.prototype.configSave()},RoadmapConfig.prototype.downPhase=function(event){event.preventDefault(),event.stopPropagation();var phaseWrapper=$(event.currentTarget).closest(".phase-wrapper"),nextPhaseWrapper=phaseWrapper.next();phaseWrapper.insertAfter(nextPhaseWrapper),RoadmapConfig.prototype.configSave()},RoadmapConfig.prototype.upCycle=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),cycleWrapper=thisnode.closest(".cycle-wrapper"),phaseContainer=thisnode.closest(".phase-container"),prevCycleWrapper=cycleWrapper.prev();prevCycleWrapper&&(cycleWrapper.insertBefore(prevCycleWrapper),phaseContainer.find(".phase-title").triggerHandler("change"))},RoadmapConfig.prototype.downCycle=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),cycleWrapper=thisnode.closest(".cycle-wrapper"),phaseContainer=thisnode.closest(".phase-container"),nextCycleWrapper=cycleWrapper.next();nextCycleWrapper&&(cycleWrapper.insertAfter(nextCycleWrapper),phaseContainer.find(".phase-title").triggerHandler("change"))},RoadmapConfig.prototype.upStep=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),stepWrapper=thisnode.closest(".step-wrapper"),cycleContainer=thisnode.closest(".cycle-container"),prevStepWrapper=stepWrapper.prev();prevStepWrapper&&(stepWrapper.insertBefore(prevStepWrapper),cycleContainer.find(".cycle-title").triggerHandler("change"))},RoadmapConfig.prototype.downStep=function(event){event.preventDefault(),event.stopPropagation();var thisnode=$(event.currentTarget),stepWrapper=thisnode.closest(".step-wrapper"),cycleContainer=thisnode.closest(".cycle-container"),nextStepWrapper=stepWrapper.next();nextStepWrapper&&(stepWrapper.insertAfter(nextStepWrapper),cycleContainer.find(".cycle-title").triggerHandler("change"))},RoadmapConfig.prototype.maxValue=function(dataType){var arrID=new Array;return $("."+dataType+"-wrapper").each((function(){let stepId=parseInt($(this).data(dataType+"id"));!1===isNaN(stepId)&&arrID.push(stepId)})),arrID.sort((function(a,b){return a-b}))[arrID.length-1]},{init:function(inputSelector,inputConfig){return new RoadmapConfig(inputSelector,inputConfig)}}}));

//# sourceMappingURL=roadmap_config.min.js.map