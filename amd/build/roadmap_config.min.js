/**
 * Handle the configuration of the roadmap.
 *
 * @module     mod_roadmap/roadmapconfig
 * @copyright  2021 Steve Bader <smbader@ncsu.edu>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_roadmap/roadmap_config",["jquery","core/notification","core/templates","mod_roadmap/expand_contract","mod_roadmap/learningobjectivesconfig","mod_roadmap/step_icon_select","mod_roadmap/step_activity_select","mod_roadmap/step_save","mod_roadmap/cycle_save","mod_roadmap/phase_save","mod_roadmap/repository"],(function($,notification,templates,ec,learningobjectives,stepiconselect,stepactivityselect,stepsave,cyclesave,phasesave,roadmaprepository){var RoadmapConfig=function(inputSelector,inputConfig){this.inputSelector=inputSelector,this.configContainer=$(inputConfig),this.initForm()};return RoadmapConfig.prototype.initForm=function(){var self=this,inputConfigVal=this.configContainer.val();""==inputConfigVal&&(inputConfigVal=JSON.stringify({phases:[]}),this.configContainer.val(inputConfigVal));var config=JSON.parse(inputConfigVal);$.each(config.phases,(function(p){let phase=config.phases[p];phase.configuration=JSON.stringify(phase),$.each(phase.cycles,(function(c){let cycle=phase.cycles[c];cycle.configuration=JSON.stringify(cycle),$.each(cycle.steps,(function(s){let step=cycle.steps[s];step.configuration=JSON.stringify(step)}))}))})),templates.render("mod_roadmap/configuration_phases",config).then((function(html,js){return templates.prependNodeContents(self.inputSelector,html,js),$(".expand-collapse-controls .collapse_everything").click((function(e){RoadmapConfig.prototype.collapseEverything(e)})),$(".expand-collapse-controls .expand_everything").click((function(e){RoadmapConfig.prototype.expandEverything(e)})),$("#roadmapconfiguration a[data-action]").click(RoadmapConfig.prototype.clickHandler),RoadmapConfig.prototype.phaseColorChange($('select[name="phasecolorpattern"]')),learningobjectives.refreshChecklists(),stepiconselect.rebindButtons(),stepactivityselect.rebindButtons(),stepsave.rebindInputs(),cyclesave.rebindInputs(),phasesave.rebindInputs(),RoadmapConfig.prototype.bindConfigSave(),require(["theme_boost/loader"]),null})).fail(notification.exception),$('select[name="phasecolorpattern"]').change((function(e){RoadmapConfig.prototype.phaseColorChange($(e.target))}))},RoadmapConfig.prototype.clickHandler=function(event){let thisnode=$(event.currentTarget),action=thisnode.data("action");"collapse_all_phases"==action?RoadmapConfig.prototype.collapsePhases():"expand_all_phases"==action?RoadmapConfig.prototype.expandPhases():"collapse_all_cycles"==action?RoadmapConfig.prototype.collapseCycles(thisnode.parent(".cycle-container-controls").next(".phase-cycles-container")):"expand_all_cycles"==action?RoadmapConfig.prototype.expandCycles(thisnode.parent(".cycle-container-controls").next(".phase-cycles-container")):"collapse_all_steps"==action?RoadmapConfig.prototype.collapseSteps(thisnode.parent(".step-container-controls").next(".cycle-steps-container")):"expand_all_steps"==action?RoadmapConfig.prototype.expandSteps(thisnode.parent(".step-container-controls").next(".cycle-steps-container")):"phase_collapse_control"==action?RoadmapConfig.prototype.collapsePhase(thisnode):"cycle_collapse_control"==action?RoadmapConfig.prototype.collapseCycle(thisnode):"step_collapse_control"==action?RoadmapConfig.prototype.collapseStep(thisnode):"phase_delete_control"==action?RoadmapConfig.prototype.deletePhase(thisnode):"cycle_delete_control"==action?RoadmapConfig.prototype.deleteCycle(thisnode):"step_delete_control"==action?RoadmapConfig.prototype.deleteStep(thisnode):"add_phase"==action?RoadmapConfig.prototype.addPhase():"phase_up_control"==action?RoadmapConfig.prototype.upPhase(thisnode):"phase_down_control"==action?RoadmapConfig.prototype.downPhase(thisnode):"add_phase_cycle"==action?RoadmapConfig.prototype.addCycle(thisnode):"cycle_up_control"==action?RoadmapConfig.prototype.upCycle(thisnode):"cycle_down_control"==action?RoadmapConfig.prototype.downCycle(thisnode):"add_cycle_step"==action?RoadmapConfig.prototype.addStep(thisnode):"step_up_control"==action?RoadmapConfig.prototype.upStep(thisnode):"step_down_control"==action&&RoadmapConfig.prototype.downStep(thisnode)},RoadmapConfig.prototype.phaseColorChange=function(node){var colorId=node.val();RoadmapConfig.prototype.getColorSet(colorId)},RoadmapConfig.prototype.getColorSet=async colorId=>{$(".phase-color-display").remove();const response=await roadmaprepository.fetchColorPattern(colorId);var colorTable=$("<div>").addClass("phase-color-display");response.forEach((function(color){colorTable.append('<div class="color" style="background-color:'+color+'"/></div>')})),$('select[name="phasecolorpattern"]').parent().append(colorTable),$("#roadmapconfiguration #phase-container > .phase-wrapper > div.row").each((function(index){let idxcolor=index%response.length;$(this).css("border-bottom","solid 1px "+response[idxcolor])}))},RoadmapConfig.prototype.bindConfigSave=function(){$("input.phase-configuration").unbind("change").change(this.configSave.bind(this))},RoadmapConfig.prototype.configSave=function(){var phaseContainer=$("#phase-container"),roadmapData=[];let index=0;$.each(phaseContainer.find(".phase-wrapper .phase-configuration"),(function(){let phaseData=$(this).val();""==phaseData&&(phaseData="{}");let phaseDataObj=JSON.parse(phaseData);phaseDataObj.index=index,index+=1,roadmapData.push(phaseDataObj)})),$('input[name="roadmapconfiguration"]').val(JSON.stringify({phases:roadmapData,phaseDeletes:$("#phase-deletes").val(),cycleDeletes:$("#cycle-deletes").val(),stepDeletes:$("#step-deletes").val()}))},RoadmapConfig.prototype.addPhase=function(){event.preventDefault(),event.stopPropagation();var config=JSON.parse($('input[name="roadmapconfiguration"]').val()),nextIndex=config.phases.length,newPhase={id:parseInt(RoadmapConfig.prototype.maxValue("phase"))+1,index:nextIndex,number:nextIndex+1};config.phases.push(newPhase),$('input[name="roadmapconfiguration"]').val(JSON.stringify(config)),templates.render("mod_roadmap/configuration_phase",newPhase).then((function(html,js){return templates.appendNodeContents("#phase-container",html,js),phasesave.rebindInputs(),RoadmapConfig.prototype.bindConfigSave(),null})).fail(notification.exception)},RoadmapConfig.prototype.addCycle=function(thisnode){var cycleContainer=thisnode.closest(".phase-container").children(".phase-cycles-container"),nextCycleIndex=cycleContainer.children(".cycle-wrapper").length;var newCycle={id:parseInt(RoadmapConfig.prototype.maxValue("cycle"))+1,index:nextCycleIndex,number:nextCycleIndex+1};templates.render("mod_roadmap/configuration_cycle",newCycle).then((function(html,js){return templates.appendNodeContents(cycleContainer,html,js),learningobjectives.refreshChecklists(),cyclesave.rebindInputs(),phasesave.rebindInputs(),null})).fail(notification.exception)},RoadmapConfig.prototype.addStep=function(thisnode){event.preventDefault(),event.stopPropagation();var stepsContainer=thisnode.closest(".cycle-container").children(".cycle-steps-container"),nextStepIndex=stepsContainer.children(".step-wrapper").length;var newStep={id:parseInt(RoadmapConfig.prototype.maxValue("step"))+1,index:nextStepIndex,number:nextStepIndex+1,stepicon:"icon-10",iconurl:$('input[name="icon_url"]').val()+"?name=icon-10&percent=100&flags=n"};templates.render("mod_roadmap/configuration_step",newStep).then((function(html,js){return templates.appendNodeContents(stepsContainer,html,js),stepiconselect.rebindButtons(),stepactivityselect.rebindButtons(),stepsave.rebindInputs(),cyclesave.rebindInputs(),null})).fail(notification.exception)},RoadmapConfig.prototype.expandPhases=function(){RoadmapConfig.prototype.expandChildrenClass($("#roadmapconfiguration"),"phase")},RoadmapConfig.prototype.expandCycles=function(node){RoadmapConfig.prototype.expandChildrenClass(node,"cycle")},RoadmapConfig.prototype.expandSteps=function(node){RoadmapConfig.prototype.expandChildrenClass(node,"step")},RoadmapConfig.prototype.collapsePhases=function(){var node=$("#roadmapconfiguration");RoadmapConfig.prototype.collapseCycles(node),RoadmapConfig.prototype.collapseChildrenClass(node,"phase")},RoadmapConfig.prototype.collapseCycles=function(node){RoadmapConfig.prototype.collapseSteps(node),RoadmapConfig.prototype.collapseChildrenClass(node,"cycle")},RoadmapConfig.prototype.collapseSteps=function(node){RoadmapConfig.prototype.collapseChildrenClass(node,"step")},RoadmapConfig.prototype.expandChildrenClass=function(parentNode,groupingName){parentNode.find('a[data-action="'+groupingName+'_collapse_control"]').each((function(){$(this).closest("."+groupingName+"-wrapper").children("."+groupingName+"-container").hasClass("hide")&&$(this).click()}))},RoadmapConfig.prototype.collapseChildrenClass=function(parentNode,groupingName){parentNode.find('a[data-action="'+groupingName+'_collapse_control"]').each((function(){$(this).closest("."+groupingName+"-wrapper").children("."+groupingName+"-container").hasClass("visible")&&$(this).click()}))},RoadmapConfig.prototype.collapsePhase=function(thisnode){var metadata=thisnode.closest(".phase-wrapper").children(".phase-container");ec.expandCollapse(metadata,thisnode)},RoadmapConfig.prototype.collapseCycle=function(thisnode){var metadata=thisnode.closest(".cycle-wrapper").children(".cycle-container");ec.expandCollapse(metadata,thisnode)},RoadmapConfig.prototype.collapseStep=function(thisnode){var metadata=thisnode.closest(".step-wrapper").children(".step-container");ec.expandCollapse(metadata,thisnode)},RoadmapConfig.prototype.deletePhase=function(thisnode){if(window.confirm("Are you sure you want to delete this Phase?")){var phaseWrapper=thisnode.closest(".phase-wrapper"),phaseId=phaseWrapper.data("phaseid");$("#phase-deletes").val($("#phase-deletes").val()+phaseId+","),phaseWrapper.remove(),RoadmapConfig.prototype.configSave()}},RoadmapConfig.prototype.deleteCycle=function(thisnode){if(window.confirm("Are you sure you want to delete this Cycle?")){var cycleWrapper=thisnode.closest(".cycle-wrapper"),phaseContainer=thisnode.closest(".phase-container"),cycleId=cycleWrapper.data("cycleid");$("#cycle-deletes").val($("#cycle-deletes").val()+cycleId+","),cycleWrapper.remove(),phaseContainer.find(".phase-title").triggerHandler("change")}},RoadmapConfig.prototype.deleteStep=function(thisnode){if(window.confirm("Are you sure you want to delete this Step?")){var stepWrapper=thisnode.closest(".step-wrapper"),cycleContainer=thisnode.closest(".cycle-container"),stepId=stepWrapper.data("stepid");$("#step-deletes").val($("#step-deletes").val()+stepId+","),stepWrapper.remove(),cycleContainer.find(".cycle-title").triggerHandler("change")}},RoadmapConfig.prototype.upPhase=function(thisnode){event.preventDefault(),event.stopPropagation();var phaseWrapper=thisnode.closest(".phase-wrapper"),prevPhaseWrapper=phaseWrapper.prev();phaseWrapper.insertBefore(prevPhaseWrapper),RoadmapConfig.prototype.configSave()},RoadmapConfig.prototype.downPhase=function(thisnode){event.preventDefault(),event.stopPropagation();var phaseWrapper=thisnode.closest(".phase-wrapper"),nextPhaseWrapper=phaseWrapper.next();phaseWrapper.insertAfter(nextPhaseWrapper),RoadmapConfig.prototype.configSave()},RoadmapConfig.prototype.upCycle=function(thisnode){event.preventDefault(),event.stopPropagation();var cycleWrapper=thisnode.closest(".cycle-wrapper"),phaseContainer=thisnode.closest(".phase-container"),prevCycleWrapper=cycleWrapper.prev();prevCycleWrapper&&(cycleWrapper.insertBefore(prevCycleWrapper),phaseContainer.find(".phase-title").triggerHandler("change"))},RoadmapConfig.prototype.downCycle=function(thisnode){event.preventDefault(),event.stopPropagation();var cycleWrapper=thisnode.closest(".cycle-wrapper"),phaseContainer=thisnode.closest(".phase-container"),nextCycleWrapper=cycleWrapper.next();nextCycleWrapper&&(cycleWrapper.insertAfter(nextCycleWrapper),phaseContainer.find(".phase-title").triggerHandler("change"))},RoadmapConfig.prototype.upStep=function(thisnode){event.preventDefault(),event.stopPropagation();var stepWrapper=thisnode.closest(".step-wrapper"),cycleContainer=thisnode.closest(".cycle-container"),prevStepWrapper=stepWrapper.prev();prevStepWrapper&&(stepWrapper.insertBefore(prevStepWrapper),cycleContainer.find(".cycle-title").triggerHandler("change"))},RoadmapConfig.prototype.downStep=function(thisnode){event.preventDefault(),event.stopPropagation();var stepWrapper=thisnode.closest(".step-wrapper"),cycleContainer=thisnode.closest(".cycle-container"),nextStepWrapper=stepWrapper.next();nextStepWrapper&&(stepWrapper.insertAfter(nextStepWrapper),cycleContainer.find(".cycle-title").triggerHandler("change"))},RoadmapConfig.prototype.maxValue=function(dataType){var arrID=new Array;return $("."+dataType+"-wrapper").each((function(){let stepId=parseInt($(this).data(dataType+"id"));!1===isNaN(stepId)&&arrID.push(stepId)})),arrID.sort((function(a,b){return a-b}))[arrID.length-1]},{init:function(inputSelector,inputConfig){return new RoadmapConfig(inputSelector,inputConfig)}}}));

//# sourceMappingURL=roadmap_config.min.js.map