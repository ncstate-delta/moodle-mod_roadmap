{"version":3,"file":"step_save.min.js","sources":["../src/step_save.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle the saving of step data and rebinding of inputs.\n *\n * @module     mod_roadmap/step_save\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery'], function($) {\n    /**\n     * StepSave class handles saving and rebinding for roadmap steps.\n     * @class\n     */\n    class StepSave {\n        /**\n         * Rebinds all inputs related to step and attaches save handlers.\n         */\n        rebindInputs() {\n            $('.roadmap-form-control-step')\n                .off('change').on('change', this.saveStep.bind(this));\n\n            this.loadList();\n\n            // Initial save for all steps (for new fields added)\n            $('.step-container').each((_, el) => {\n                this.saveStep({target: el});\n            });\n        }\n\n        /**\n         * Loads and renders the completion activity list for each step.\n         */\n        loadList() {\n            const activityData = JSON.parse($('input[name=\"activity_data\"]').val() || '{}');\n            $('ul.step-completion-list').each(function() {\n                const $list = $(this);\n                // Get the configuration line from the local hidden field\n                const stepCompletionModules = $list.closest('.step-activity-container')\n                    .find('.step-completion-modules').val() || '';\n                const selectedIds = stepCompletionModules.split(',').filter(x => x);\n\n                $list.empty();\n                if (activityData.activities && Array.isArray(activityData.activities)) {\n                    activityData.activities.forEach(function(activity) {\n                        if (selectedIds.includes(activity.id)) {\n                            const li = $('<li/>').attr('data-id', activity.id);\n                            $('<span>').text(activity.name).appendTo(li);\n                            $list.append(li);\n                        }\n                    });\n                }\n                const singleActivitySection = $(this).closest('.step-container').find('.single-activity-link-container');\n                const linkPageContainer = $(this).closest('.step-container').find('.link-to-page-container');\n\n                if (selectedIds.length === 1) {\n                    // Show and enable when exactly one activity is selected\n                    singleActivitySection.show();\n\n                    const linksingleactivity = $(this).closest('.step-container').find('.fitem input.chk-single-activity-link')\n                        .prop(\"checked\") ? 1 : 0;\n                    if (linksingleactivity) {\n                        linkPageContainer.show();\n                    } else {\n                        linkPageContainer.hide();\n                    }\n                } else {\n                    // Hide and uncheck when 0 or more than 1 activity is selected\n                    singleActivitySection.hide();\n                    linkPageContainer.hide();\n                }\n            });\n        }\n\n        /**\n         * Saves the step data to its hidden config input.\n         * @param {Event|Object} event Event or jQuery-wrapped element reference.\n         */\n        saveStep(event) {\n            // Support both event and direct call with element\n            const $stepContainer = $(event.target).closest('.step-container');\n\n            this.updateLinkToPage(event);\n\n            // Link single activity check box option.\n            const linksingleactivity = $stepContainer.find('.fitem input.chk-single-activity-link')\n                .prop(\"checked\") ? 1 : 0;\n\n            const rollovertext = $stepContainer.find('.fitem input.step-rollovertext').val();\n\n            const stepData = {\n                id: $stepContainer.closest('.step-wrapper').data('stepid'),\n                rollovertext: rollovertext,\n                stepicon: $stepContainer.find('.fitem input.step-icon').val(),\n                completionmodules: $stepContainer.find('.fitem input.step-completion-modules').val(),\n                linksingleactivity: linksingleactivity,\n                pagelink: $stepContainer.find('.fitem input.step-single-activity-link').val(),\n                completionexpectedcmid: $stepContainer.find('.fitem input.expectedcomplete-coursemoduleid').val(),\n                completionexpecteddatetime: $stepContainer.find('.fitem input.expectedcomplete-datetime').val(),\n            };\n\n            $stepContainer.closest('.step-wrapper').find('.step-header-title').html(rollovertext);\n            $stepContainer.children('input.step-configuration')\n                .val(JSON.stringify(stepData))\n                .triggerHandler(\"change\");\n        }\n\n        /**\n         * Updates the link to page field based on selected activity.\n         * @param {Event} event Change event.\n         */\n        updateLinkToPage(event) {\n\n            const stepContainer = $(event.target).closest('.step-container');\n            const linksingleactivity = stepContainer.find('.fitem input.chk-single-activity-link')\n                .prop(\"checked\") ? 1 : 0;\n\n            const linkPageContainer = stepContainer.find('.link-to-page-container');\n            if (linksingleactivity) {\n                linkPageContainer.show();\n            } else {\n                linkPageContainer.hide();\n            }\n\n        }\n    }\n\n    // AMD export\n    const instance = new StepSave();\n    return {\n        /**\n         * Initialize StepSave (returns instance).\n         * @returns {StepSave}\n         */\n        init: function() {\n            return instance;\n        },\n        /**\n         * Rebinds all step input handlers.\n         */\n        rebindInputs: function() {\n            instance.rebindInputs();\n        }\n    };\n});"],"names":["define","$","instance","rebindInputs","off","on","this","saveStep","bind","loadList","each","_","el","target","activityData","JSON","parse","val","$list","selectedIds","closest","find","split","filter","x","empty","activities","Array","isArray","forEach","activity","includes","id","li","attr","text","name","appendTo","append","singleActivitySection","linkPageContainer","length","show","prop","hide","event","$stepContainer","updateLinkToPage","linksingleactivity","rollovertext","stepData","data","stepicon","completionmodules","pagelink","completionexpectedcmid","completionexpecteddatetime","html","children","stringify","triggerHandler","stepContainer","init"],"mappings":";;;;;;AAqBAA,+BAAO,CAAC,WAAW,SAASC,SAuHlBC,SAAW,UA9GbC,eACIF,EAAE,8BACGG,IAAI,UAAUC,GAAG,SAAUC,KAAKC,SAASC,KAAKF,YAE9CG,WAGLR,EAAE,mBAAmBS,MAAK,CAACC,EAAGC,WACrBL,SAAS,CAACM,OAAQD,QAO/BH,iBACUK,aAAeC,KAAKC,MAAMf,EAAE,+BAA+BgB,OAAS,MAC1EhB,EAAE,2BAA2BS,MAAK,iBACxBQ,MAAQjB,EAAEK,MAIVa,aAFwBD,MAAME,QAAQ,4BACvCC,KAAK,4BAA4BJ,OAAS,IACLK,MAAM,KAAKC,QAAOC,GAAKA,IAEjEN,MAAMO,QACFX,aAAaY,YAAcC,MAAMC,QAAQd,aAAaY,aACtDZ,aAAaY,WAAWG,SAAQ,SAASC,aACjCX,YAAYY,SAASD,SAASE,IAAK,OAC7BC,GAAKhC,EAAE,SAASiC,KAAK,UAAWJ,SAASE,IAC/C/B,EAAE,UAAUkC,KAAKL,SAASM,MAAMC,SAASJ,IACzCf,MAAMoB,OAAOL,cAInBM,sBAAwBtC,EAAEK,MAAMc,QAAQ,mBAAmBC,KAAK,mCAChEmB,kBAAoBvC,EAAEK,MAAMc,QAAQ,mBAAmBC,KAAK,8BAEvC,IAAvBF,YAAYsB,OAAc,CAE1BF,sBAAsBG,QAEKzC,EAAEK,MAAMc,QAAQ,mBAAmBC,KAAK,yCAC9DsB,KAAK,WAAa,EAAI,GAEvBH,kBAAkBE,OAElBF,kBAAkBI,YAItBL,sBAAsBK,OACtBJ,kBAAkBI,UAS9BrC,SAASsC,aAECC,eAAiB7C,EAAE4C,MAAMhC,QAAQO,QAAQ,wBAE1C2B,iBAAiBF,aAGhBG,mBAAqBF,eAAezB,KAAK,yCAC1CsB,KAAK,WAAa,EAAI,EAErBM,aAAeH,eAAezB,KAAK,kCAAkCJ,MAErEiC,SAAW,CACblB,GAAIc,eAAe1B,QAAQ,iBAAiB+B,KAAK,UACjDF,aAAcA,aACdG,SAAUN,eAAezB,KAAK,0BAA0BJ,MACxDoC,kBAAmBP,eAAezB,KAAK,wCAAwCJ,MAC/E+B,mBAAoBA,mBACpBM,SAAUR,eAAezB,KAAK,0CAA0CJ,MACxEsC,uBAAwBT,eAAezB,KAAK,gDAAgDJ,MAC5FuC,2BAA4BV,eAAezB,KAAK,0CAA0CJ,OAG9F6B,eAAe1B,QAAQ,iBAAiBC,KAAK,sBAAsBoC,KAAKR,cACxEH,eAAeY,SAAS,4BACnBzC,IAAIF,KAAK4C,UAAUT,WACnBU,eAAe,UAOxBb,iBAAiBF,aAEPgB,cAAgB5D,EAAE4C,MAAMhC,QAAQO,QAAQ,mBACxC4B,mBAAqBa,cAAcxC,KAAK,yCACzCsB,KAAK,WAAa,EAAI,EAErBH,kBAAoBqB,cAAcxC,KAAK,2BACzC2B,mBACAR,kBAAkBE,OAElBF,kBAAkBI,eAQvB,CAKHkB,KAAM,kBACK5D,UAKXC,aAAc,WACVD,SAASC"}