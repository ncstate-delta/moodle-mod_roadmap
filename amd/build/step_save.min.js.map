{"version":3,"file":"step_save.min.js","sources":["../src/step_save.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle the saving of step data and rebinding of inputs.\n *\n * @module     mod_roadmap/step_save\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery'], function($) {\n    /**\n     * StepSave class handles saving and rebinding for roadmap steps.\n     * @class\n     */\n    class StepSave {\n        /**\n         * Rebinds all inputs related to step and attaches save handlers.\n         */\n        rebindInputs() {\n            $('.roadmap-form-control-step')\n                .off('change').on('change', this.saveStep.bind(this));\n            this.loadList();\n            // Initial save for all steps (for new fields added)\n            $('.step-container').each((_, el) => {\n                this.saveStep({target: el});\n            });\n        }\n\n        /**\n         * Loads and renders the completion activity list for each step.\n         */\n        loadList() {\n            const activityData = JSON.parse($('input[name=\"activity_data\"]').val() || '{}');\n            $('ul.step-completion-list').each(function() {\n                const $list = $(this);\n                // Get the configuration line from the local hidden field\n                const stepCompletionModules = $list.closest('.step-activity-container')\n                    .find('.step-completion-modules').val() || '';\n                const selectedIds = stepCompletionModules.split(',').filter(x => x);\n\n                $list.empty();\n                if (activityData.activities && Array.isArray(activityData.activities)) {\n                    activityData.activities.forEach(function(activity) {\n                        if (selectedIds.includes(activity.id)) {\n                            const li = $('<li/>').attr('data-id', activity.id);\n                            $('<span>').text(activity.name).appendTo(li);\n                            $list.append(li);\n                        }\n                    });\n                }\n            });\n        }\n\n        /**\n         * Saves the step data to its hidden config input.\n         * @param {Event|Object} event Event or jQuery-wrapped element reference.\n         */\n        saveStep(event) {\n            // Support both event and direct call with element\n            const $stepContainer = $(event.target).closest('.step-container');\n            // Link single activity check box option.\n            const linksingleactivity = $stepContainer.find('.fitem input.chk-single-activity-link')\n                .prop(\"checked\") ? 1 : 0;\n\n            const rollovertext = $stepContainer.find('.fitem input.step-rollovertext').val();\n\n            const stepData = {\n                id: $stepContainer.closest('.step-wrapper').data('stepid'),\n                rollovertext: rollovertext,\n                stepicon: $stepContainer.find('.fitem input.step-icon').val(),\n                completionmodules: $stepContainer.find('.fitem input.step-completion-modules').val(),\n                linksingleactivity: linksingleactivity,\n                pagelink: $stepContainer.find('.fitem input.step-single-activity-link').val(),\n                completionexpectedcmid: $stepContainer.find('.fitem input.expectedcomplete-coursemoduleid').val(),\n                completionexpecteddatetime: $stepContainer.find('.fitem input.expectedcomplete-datetime').val(),\n            };\n\n            $stepContainer.closest('.step-wrapper').find('.step-header-title').html(rollovertext);\n            $stepContainer.children('input.step-configuration')\n                .val(JSON.stringify(stepData)).triggerHandler(\"change\");\n        }\n    }\n\n    // AMD export\n    const instance = new StepSave();\n    return {\n        /**\n         * Initialize StepSave (returns instance).\n         * @returns {StepSave}\n         */\n        init: function() { return instance; },\n        /**\n         * Rebinds all step input handlers.\n         */\n        rebindInputs: function() { instance.rebindInputs(); }\n    };\n});"],"names":["define","$","instance","rebindInputs","off","on","this","saveStep","bind","loadList","each","_","el","target","activityData","JSON","parse","val","$list","selectedIds","closest","find","split","filter","x","empty","activities","Array","isArray","forEach","activity","includes","id","li","attr","text","name","appendTo","append","event","$stepContainer","linksingleactivity","prop","rollovertext","stepData","data","stepicon","completionmodules","pagelink","completionexpectedcmid","completionexpecteddatetime","html","children","stringify","triggerHandler","init"],"mappings":";;;;;;AAqBAA,+BAAO,CAAC,WAAW,SAASC,SA2ElBC,SAAW,UAlEbC,eACIF,EAAE,8BACGG,IAAI,UAAUC,GAAG,SAAUC,KAAKC,SAASC,KAAKF,YAC9CG,WAELR,EAAE,mBAAmBS,MAAK,CAACC,EAAGC,WACrBL,SAAS,CAACM,OAAQD,QAO/BH,iBACUK,aAAeC,KAAKC,MAAMf,EAAE,+BAA+BgB,OAAS,MAC1EhB,EAAE,2BAA2BS,MAAK,iBACxBQ,MAAQjB,EAAEK,MAIVa,aAFwBD,MAAME,QAAQ,4BACvCC,KAAK,4BAA4BJ,OAAS,IACLK,MAAM,KAAKC,QAAOC,GAAKA,IAEjEN,MAAMO,QACFX,aAAaY,YAAcC,MAAMC,QAAQd,aAAaY,aACtDZ,aAAaY,WAAWG,SAAQ,SAASC,aACjCX,YAAYY,SAASD,SAASE,IAAK,OAC7BC,GAAKhC,EAAE,SAASiC,KAAK,UAAWJ,SAASE,IAC/C/B,EAAE,UAAUkC,KAAKL,SAASM,MAAMC,SAASJ,IACzCf,MAAMoB,OAAOL,WAWjC1B,SAASgC,aAECC,eAAiBvC,EAAEsC,MAAM1B,QAAQO,QAAQ,mBAEzCqB,mBAAqBD,eAAenB,KAAK,yCAC1CqB,KAAK,WAAa,EAAI,EAErBC,aAAeH,eAAenB,KAAK,kCAAkCJ,MAErE2B,SAAW,CACbZ,GAAIQ,eAAepB,QAAQ,iBAAiByB,KAAK,UACjDF,aAAcA,aACdG,SAAUN,eAAenB,KAAK,0BAA0BJ,MACxD8B,kBAAmBP,eAAenB,KAAK,wCAAwCJ,MAC/EwB,mBAAoBA,mBACpBO,SAAUR,eAAenB,KAAK,0CAA0CJ,MACxEgC,uBAAwBT,eAAenB,KAAK,gDAAgDJ,MAC5FiC,2BAA4BV,eAAenB,KAAK,0CAA0CJ,OAG9FuB,eAAepB,QAAQ,iBAAiBC,KAAK,sBAAsB8B,KAAKR,cACxEH,eAAeY,SAAS,4BACnBnC,IAAIF,KAAKsC,UAAUT,WAAWU,eAAe,kBAMnD,CAKHC,KAAM,kBAAoBrD,UAI1BC,aAAc,WAAaD,SAASC"}