{"version":3,"file":"step_icon_select.min.js","sources":["../src/step_icon_select.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle opening a modal for step icon selection.\n *\n * @module     mod_roadmap/stepiconselect\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'core/templates',\n    'core/ajax',\n    'core/modal_save_cancel',\n    'core/modal_events'\n], function(\n    $,\n    Str,\n    Notification,\n    Templates,\n    Ajax,\n    ModalSaveCancel,\n    ModalEvents\n) {\n\n        var SELECTORS = {\n            SELECT_ICON_BUTTON: '.btn_icon_selector'\n        };\n\n        var StepIconSelector = function() {\n            this.registerEventListeners();\n        };\n\n        StepIconSelector.prototype.registerEventListeners = function() {\n\n            var trigger = $(SELECTORS.SELECT_ICON_BUTTON);\n            var stringkeys = [\n                {\n                    key: 'selecticon',\n                    component: 'mod_roadmap'\n                },\n                {\n                    key: 'saveselection',\n                    component: 'mod_roadmap'\n                }\n            ];\n\n            trigger.off('click').on('click', function(e) {\n                let stepId = $(e.target).data('stepid');\n\n                Str.get_strings(stringkeys).then(function(strings) {\n                    return Promise.all([\n                        ModalSaveCancel.create({\n                            title: strings[0],\n                            body: '',\n                        }),\n                        strings[1],\n                    ]).then(function([modal, string]) {\n                        this.setupFormModal(modal, stepId, string);\n                        return modal;\n                    }.bind(this));\n                }.bind(this))\n                .catch(Notification.exception);\n            }.bind(this));\n\n        };\n\n        /**\n         * @method getBody\n         * @private\n         * @return {Promise}\n         */\n        StepIconSelector.prototype.getBody = function() {\n            // TODO, would like to fetch icon list with a server call\n            var iconsData = JSON.parse($('input[name=\"icon_data\"]').val());\n\n            // Let's find all of the currently selected icons and add them.\n            $('.step-wrapper .step-container .step-icon-display img.step-icon').each(function() {\n                let iconfilename = $(this).data('iconfilename');\n                let iconsrc = $(this).attr('src');\n                let usedicon = {file: iconfilename, iconurl: iconsrc};\n\n                if (iconsData.categories[0].icons.some(icon => icon.file === iconfilename)) {\n                    // Icon already exists in currently used category.\n                } else {\n                    iconsData.categories[0].icons.push(usedicon);\n                }\n            });\n\n            // Get the content of the modal.\n            return Templates.render('mod_roadmap/configuration_iconselect', iconsData);\n        };\n\n        StepIconSelector.prototype.setupFormModal = function(modal, stepId, saveText) {\n            modal.setLarge();\n\n            modal.setSaveButtonText(saveText);\n\n            // We want to reset the form every time it is opened.\n            modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n            modal.setBody(this.getBody());\n\n            modal.getRoot().on('click', 'img.icon', function(e) {\n                let iconFileName = $(e.target).data('iconfilename');\n                $('.modal-body .icon-container img.icon.selected').removeClass('selected');\n                $(e.target).addClass('selected');\n\n                // I have the icon name, I need to hold it temp in the modal until save.\n                $('#current-selected-icon').val(iconFileName);\n\n                // I need to update the example icons in the footer of the modal.\n                this.updatePreviewIcons(iconFileName);\n\n            }.bind(this));\n\n\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\n                var iconFileName = $(\"input[name=step-\" + stepId + \"-icon]\").val();\n                $(\".modal-body .icon-container img.icon[data-iconfilename=\" + iconFileName + \"]\").addClass('selected');\n\n                // I have the icon name, I need to hold it temp in the modal until save.\n                $('#current-selected-icon').val(iconFileName);\n                $('#step-id').val(stepId);\n\n                // I need to update the example icons in the footer of the modal.\n                StepIconSelector.prototype.updatePreviewIcons(iconFileName);\n            }).bind(this);\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n\n            modal.getRoot().on('submit', 'form', this.submitForm.bind(this));\n\n            this.modal = modal;\n\n            modal.show();\n        };\n\n        StepIconSelector.prototype.updatePreviewIcons = function(iconFileName) {\n            let iconUrl = $('input[name=\"icon_url\"]').val();\n\n            $('div.selected-icon-container > span.img-incomplete > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=0');\n            $('div.selected-icon-container > span.img-partial > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=66');\n            $('div.selected-icon-container > span.img-alert > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=66&flags=a');\n            $('div.selected-icon-container > span.img-complete > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=100');\n            $('div.selected-icon-container > span.img-ontime > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=100&flags=s');\n        };\n\n        StepIconSelector.prototype.submitForm = function(e) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            let iconUrl = $('input[name=\"icon_url\"]').val();\n            let iconFileName = $('#current-selected-icon').val();\n            let stepId = $('#step-id').val();\n\n            let inputStep = $('input[name=\"step-' + stepId + '-icon\"]');\n            let imgStep = inputStep.parent('.step-icon-display').children('img').first();\n\n            imgStep.attr('src', iconUrl + '?name=' + iconFileName + '&percent=100&flags=n');\n            imgStep.removeAttr('data-iconfilename').removeData('iconfilename');\n            imgStep.attr('data-iconfilename', iconFileName);\n\n            inputStep.val(iconFileName);\n            inputStep.trigger('change');\n            this.destroy();\n        };\n\n        StepIconSelector.prototype.destroy = function() {\n            this.modal.destroy();\n        };\n\n        StepIconSelector.prototype.initIconConfig = function(popup) {\n            this.popup = popup;\n            var body = $(popup.getContent());\n\n\n            body.on('click', '[data-action=\"cancel\"]', function() {\n                popup.close();\n            });\n        };\n\n        return {\n\n            /**\n             * Main initialisation.\n             *\n             * @return {StepIconSelector} A new instance of StepIconSelector.\n             * @method init\n             */\n            init: function() {\n                return new StepIconSelector();\n            },\n\n            rebindButtons: function() {\n                StepIconSelector.prototype.registerEventListeners();\n            }\n        };\n});"],"names":["define","$","Str","Notification","Templates","Ajax","ModalSaveCancel","ModalEvents","SELECTORS","StepIconSelector","registerEventListeners","prototype","trigger","stringkeys","key","component","off","on","e","stepId","target","data","get_strings","then","strings","Promise","all","create","title","body","modal","string","setupFormModal","bind","this","catch","exception","getBody","iconsData","JSON","parse","val","each","iconfilename","iconsrc","attr","usedicon","file","iconurl","categories","icons","some","icon","push","render","saveText","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","iconFileName","removeClass","addClass","updatePreviewIcons","bodyRendered","save","submitForm","show","iconUrl","preventDefault","inputStep","imgStep","parent","children","first","removeAttr","removeData","initIconConfig","popup","getContent","close","init","rebindButtons"],"mappings":"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"}