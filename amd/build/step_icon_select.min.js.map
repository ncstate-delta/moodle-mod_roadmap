{"version":3,"file":"step_icon_select.min.js","sources":["../src/step_icon_select.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle opening a modal for step icon selection.\n *\n * @module     mod_roadmap/stepiconselect\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/notification',\n    'core/templates',\n    'core/ajax',\n    'core/modal_save_cancel',\n    'core/modal_events'\n], function(\n    $,\n    Str,\n    Notification,\n    Templates,\n    Ajax,\n    ModalSaveCancel,\n    ModalEvents\n) {\n\n        var SELECTORS = {\n            SELECT_ICON_BUTTON: '.btn_icon_selector'\n        };\n\n        var StepIconSelector = function() {\n            this.registerEventListeners();\n        };\n\n        StepIconSelector.prototype.registerEventListeners = function() {\n\n            var trigger = $(SELECTORS.SELECT_ICON_BUTTON);\n            var stringkeys = [\n                {\n                    key: 'selecticon',\n                    component: 'mod_roadmap'\n                },\n                {\n                    key: 'saveselection',\n                    component: 'mod_roadmap'\n                }\n            ];\n\n            trigger.off('click').on('click', function(e) {\n                let stepId = $(e.target).parent('.btn_icon_selector').data('stepid');\n\n                Str.get_strings(stringkeys).then(function(strings) {\n                    return Promise.all([\n                        ModalSaveCancel.create({\n                            title: strings[0],\n                            body: '',\n                        }),\n                        strings[1],\n                    ]).then(function([modal, string]) {\n                        this.setupFormModal(modal, stepId, string);\n                        return modal;\n                    }.bind(this));\n                }.bind(this))\n                .catch(Notification.exception);\n            }.bind(this));\n\n        };\n\n        /**\n         * @method getBody\n         * @private\n         * @return {Promise}\n         */\n        StepIconSelector.prototype.getBody = function() {\n            // TODO, would like to fetch icon list with a server call\n            var iconsData = JSON.parse($('input[name=\"icon_data\"]').val());\n\n            // Let's find all of the currently selected icons and add them.\n            $('.step-wrapper .step-container .step-icon-display img.step-icon').each(function() {\n                let iconfilename = $(this).data('iconfilename');\n                let iconsrc = $(this).attr('src');\n                let usedicon = {file: iconfilename, iconurl: iconsrc};\n\n                if (iconsData.categories[0].icons.some(icon => icon.file === iconfilename)) {\n                    // Icon already exists in currently used category.\n                } else {\n                    iconsData.categories[0].icons.push(usedicon);\n                }\n            });\n\n            // Get the content of the modal.\n            return Templates.render('mod_roadmap/configuration_iconselect', iconsData);\n        };\n\n        StepIconSelector.prototype.setupFormModal = function(modal, stepId, saveText) {\n            modal.setLarge();\n\n            modal.setSaveButtonText(saveText);\n\n            // We want to reset the form every time it is opened.\n            modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n            modal.setBody(this.getBody());\n\n            modal.getRoot().on('click', 'img.icon', function(e) {\n                let iconFileName = $(e.target).data('iconfilename');\n                $('.modal-body .icon-container img.icon.selected').removeClass('selected');\n                $(e.target).addClass('selected');\n\n                // I have the icon name, I need to hold it temp in the modal until save.\n                $('#current-selected-icon').val(iconFileName);\n\n                // I need to update the example icons in the footer of the modal.\n                this.updatePreviewIcons(iconFileName);\n\n            }.bind(this));\n\n\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\n                var iconFileName = $(\"input[name=step-\" + stepId + \"-icon]\").val();\n                $(\".modal-body .icon-container img.icon[data-iconfilename=\" + iconFileName + \"]\").addClass('selected');\n\n                // I have the icon name, I need to hold it temp in the modal until save.\n                $('#current-selected-icon').val(iconFileName);\n                $('#step-id').val(stepId);\n\n                // I need to update the example icons in the footer of the modal.\n                StepIconSelector.prototype.updatePreviewIcons(iconFileName);\n            }).bind(this);\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n\n            this.modal = modal;\n\n            modal.show();\n        };\n\n        StepIconSelector.prototype.updatePreviewIcons = function(iconFileName) {\n            let iconUrl = $('input[name=\"icon_url\"]').val();\n\n            $('div.selected-icon-container > span.img-incomplete > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=0');\n            $('div.selected-icon-container > span.img-partial > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=66');\n            $('div.selected-icon-container > span.img-alert > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=66&flags=a');\n            $('div.selected-icon-container > span.img-complete > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=100');\n            $('div.selected-icon-container > span.img-ontime > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=100&flags=s');\n        };\n\n        StepIconSelector.prototype.submitForm = function(e) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            let iconUrl = $('input[name=\"icon_url\"]').val();\n            let iconFileName = $('#current-selected-icon').val();\n            let stepId = $('#step-id').val();\n\n            let inputStep = $('input[name=\"step-' + stepId + '-icon\"]');\n            let imgStep = inputStep.parent('.step-icon-display').find('img').first();\n\n            imgStep.attr('src', iconUrl + '?name=' + iconFileName + '&percent=100&flags=n');\n            imgStep.removeAttr('data-iconfilename').removeData('iconfilename');\n            imgStep.attr('data-iconfilename', iconFileName);\n\n            inputStep.val(iconFileName);\n            inputStep.trigger('change');\n            this.destroy();\n        };\n\n        StepIconSelector.prototype.destroy = function() {\n            this.modal.destroy();\n        };\n\n        StepIconSelector.prototype.initIconConfig = function(popup) {\n            this.popup = popup;\n            var body = $(popup.getContent());\n\n\n            body.on('click', '[data-action=\"cancel\"]', function() {\n                popup.close();\n            });\n        };\n\n        return {\n\n            /**\n             * Main initialisation.\n             *\n             * @return {StepIconSelector} A new instance of StepIconSelector.\n             * @method init\n             */\n            init: function() {\n                return new StepIconSelector();\n            },\n\n            rebindButtons: function() {\n                StepIconSelector.prototype.registerEventListeners();\n            }\n        };\n});"],"names":["define","$","Str","Notification","Templates","Ajax","ModalSaveCancel","ModalEvents","SELECTORS","StepIconSelector","registerEventListeners","prototype","trigger","stringkeys","key","component","off","on","e","stepId","target","parent","data","get_strings","then","strings","Promise","all","create","title","body","modal","string","setupFormModal","bind","this","catch","exception","getBody","iconsData","JSON","parse","val","each","iconfilename","iconsrc","attr","usedicon","file","iconurl","categories","icons","some","icon","push","render","saveText","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","iconFileName","removeClass","addClass","updatePreviewIcons","bodyRendered","save","submitForm","show","iconUrl","preventDefault","inputStep","imgStep","find","first","removeAttr","removeData","initIconConfig","popup","getContent","close","init","rebindButtons"],"mappings":"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"}