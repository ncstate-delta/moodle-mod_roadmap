{"version":3,"file":"step_icon_select.min.js","sources":["../src/step_icon_select.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle opening a dialogue to configure scale data.\n *\n * @module     mod_roadmap/stepiconselect\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/notification',\n    'core/templates',\n    'core/ajax',\n    'core/modal_factory',\n    'core/modal_events'\n], function(\n    $,\n    notification,\n    templates,\n    ajax,\n    ModalFactory,\n    ModalEvents\n) {\n\n        var SELECTORS = {\n            SELECT_ICON_BUTTON: '.btn_icon_selector'\n        };\n\n        var StepIconSelector = function() {\n            this.registerEventListeners();\n        };\n\n        StepIconSelector.prototype.registerEventListeners = function() {\n\n            var trigger = $(SELECTORS.SELECT_ICON_BUTTON);\n\n            trigger.off('click').on('click', function(e) {\n                let stepId = $(e.target).data('stepid');\n\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: 'Choose Step Icon',\n                    body: '',\n                }, trigger).done(function(modal) {\n                    this.setupFormModal(modal, stepId, 'Save Selection');\n                }.bind(this));\n            }.bind(this));\n        };\n\n        /**\n         * @method getBody\n         * @private\n         * @return {Promise}\n         */\n        StepIconSelector.prototype.getBody = function() {\n            // TODO, would like to fetch icon list with a server call\n            var iconsData = JSON.parse($('input[name=\"icon_data\"]').val());\n\n            // Let's find all of the currently selected icons and add them.\n            $('.step-wrapper .step-container .step-icon-display img.step-icon').each(function() {\n                let iconfilename = $(this).data('iconfilename');\n                let iconsrc = $(this).attr('src');\n                let usedicon = { file: iconfilename, iconurl: iconsrc };\n\n                if (iconsData.categories[0].icons.some(icon => icon.file === iconfilename)) {\n                    // Icon already exists in currently used category.\n                } else {\n                    iconsData.categories[0].icons.push(usedicon);\n                }\n            });\n\n            // Get the content of the modal.\n            return templates.render('mod_roadmap/configuration_iconselect', iconsData);\n        };\n\n        StepIconSelector.prototype.setupFormModal = function(modal, stepId, saveText) {\n            modal.setLarge();\n\n            modal.setSaveButtonText(saveText);\n\n            // We want to reset the form every time it is opened.\n            modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n            modal.setBody(this.getBody());\n\n            modal.getRoot().on('click', 'img.icon', function(e) {\n                let iconFileName = $(e.target).data('iconfilename');\n                $('.modal-body .icon-container img.icon.selected').removeClass('selected');\n                $(e.target).addClass('selected');\n\n                // I have the icon name, I need to hold it temp in the modal until save.\n                $('#current-selected-icon').val(iconFileName);\n\n                // I need to update the example icons in the footer of the modal.\n                this.updatePreviewIcons(iconFileName);\n\n            }.bind(this));\n\n\n            modal.getRoot().on(ModalEvents.bodyRendered, function() {\n                var iconFileName = $(\"input[name=step-\" + stepId + \"-icon]\").val();\n                $(\".modal-body .icon-container img.icon[data-iconfilename=\" + iconFileName + \"]\").addClass('selected');\n\n                // I have the icon name, I need to hold it temp in the modal until save.\n                $('#current-selected-icon').val(iconFileName);\n                $('#step-id').val(stepId);\n\n                // I need to update the example icons in the footer of the modal.\n                StepIconSelector.prototype.updatePreviewIcons(iconFileName);\n            }).bind(this);\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n\n            modal.getRoot().on('submit', 'form', this.submitForm.bind(this));\n\n            this.modal = modal;\n\n            modal.show();\n        };\n\n        StepIconSelector.prototype.updatePreviewIcons = function(iconFileName) {\n            let iconUrl = $('input[name=\"icon_url\"]').val();\n\n            $('div.selected-icon-container > span.img-incomplete > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=0');\n            $('div.selected-icon-container > span.img-partial > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=66');\n            $('div.selected-icon-container > span.img-alert > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=66&flags=a');\n            $('div.selected-icon-container > span.img-complete > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=100');\n            $('div.selected-icon-container > span.img-ontime > img.icon').attr('src',\n                iconUrl + '?name=' + iconFileName + '&percent=100&flags=s');\n        };\n\n        StepIconSelector.prototype.submitForm = function(e) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            let iconUrl = $('input[name=\"icon_url\"]').val();\n            let iconFileName = $('#current-selected-icon').val();\n            let stepId = $('#step-id').val();\n\n            let inputStep = $('input[name=\"step-' + stepId + '-icon\"]');\n            let imgStep = inputStep.parent('.step-icon-display').children('img').first();\n\n            imgStep.attr('src', iconUrl + '?name=' + iconFileName + '&percent=100&flags=n');\n            imgStep.removeAttr('data-iconfilename').removeData('iconfilename');\n            imgStep.attr('data-iconfilename', iconFileName);\n\n            inputStep.val(iconFileName);\n            inputStep.trigger('change');\n            this.destroy();\n        };\n\n        StepIconSelector.prototype.destroy = function() {\n            this.modal.destroy();\n        };\n\n        StepIconSelector.prototype.initIconConfig = function(popup) {\n            this.popup = popup;\n            var body = $(popup.getContent());\n\n\n            body.on('click', '[data-action=\"cancel\"]', function() {\n                popup.close();\n            });\n        };\n\n        return {\n\n            /**\n             * Main initialisation.\n             *\n             * @return {ScaleConfig} A new instance of ScaleConfig.\n             * @method init\n             */\n            init: function() {\n                return new StepIconSelector();\n            },\n\n            rebindButtons: function() {\n                StepIconSelector.prototype.registerEventListeners();\n            }\n        };\n});"],"names":["define","$","notification","templates","ajax","ModalFactory","ModalEvents","SELECTORS","StepIconSelector","registerEventListeners","prototype","trigger","off","on","e","stepId","target","data","create","type","types","SAVE_CANCEL","title","body","done","modal","setupFormModal","bind","this","getBody","iconsData","JSON","parse","val","each","iconfilename","iconsrc","attr","usedicon","file","iconurl","categories","icons","some","icon","push","render","saveText","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","iconFileName","removeClass","addClass","updatePreviewIcons","bodyRendered","save","submitForm","show","iconUrl","preventDefault","inputStep","imgStep","parent","children","first","removeAttr","removeData","initIconConfig","popup","getContent","close","init","rebindButtons"],"mappings":"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"}